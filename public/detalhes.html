<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Gloscars - Detalhes do Filme</title>
  <link rel="stylesheet" href="/assets/css/styles.css">
  <script>
  (()=>{
    const logado = sessionStorage.getItem('isLoggedIn');
        if (logado !== '1' || !logado) {
            window.location.href = 'login.html';
            return;
        }
  })();
  document.addEventListener('DOMContentLoaded', () => {
      const admin = JSON.parse(sessionStorage.getItem('usuarioCorrente') || '{}');

      if (admin.admin === 0) {
          // Se estiver na página de registro, bloqueia
          if (window.location.pathname.endsWith('register.html')) {
              alert('Acesso negado. Você não é um admin.');
              window.location.href = 'index.html';
          }

          // Esconde o link de registro no menu
          const regLink = document.querySelector('a[href="register.html"]');
          if (regLink) regLink.style.display = 'none';
      }
  });
  </script>
  <style>
    .poster-wrapper {
      position: relative; /* necessário para o overlay funcionar */
      display: inline-block;
  }

.carousel {
  overflow: hidden;
  width: 100%;
}

.group {
  display: flex;
  gap: 10px;
  width: max-content; 
  animation: scroll 35s linear infinite;
}

.c {
  width: 160px;
  height: auto;
  flex: 0 0 auto;
  display: flex;           
  align-items: center;     
  justify-content: center; 
  overflow: hidden;
  border-radius: 6px;
}

.c img {
  max-height: 100%;
  max-width: 100%;
  object-fit: contain;
  display: block;
}

@keyframes scroll {
  from {
    transform: translateX(0);
  }
  to {
    transform: translateX(-50%); /* anda metade porque duplicamos */
  }
}
.favorite-icon {
border-radius: 50px;
cursor: pointer;
user-select: none;
text-shadow: 0 0 4px rgba(0, 0, 0, 0.7);
align-items: center;
display: flex;
}
.favorite-icon svg {
    transition: transform 0.2s;
    width: 20px;
    fill: white;
    margin-top: 7px;
}
#trfav {
fill: #b39930;
}
.favorite-icon svg:hover {
    transform: scale(1.05);
}
  </style>
</head>
<body class="bg-black text-white">
<header>
    <a href="index.html"><div class="logo">
        <img src="/assets/img/logo.svg" style="max-width: 180px; filter: brightness(50)">
    </div></a>
    <nav>
        <ul id="menuList">
            <a href="index.html" style="color: inherit; text-decoration: inherit;"><li>Início</li></a>
            <a href="register.html" style="color: inherit; text-decoration: inherit;"><li>Cadastro</li></a>
            <a href="favorites.html" style="color: inherit; text-decoration: inherit;"><li>Favorito</li></a>
            <a href="login.html" style="color: inherit; text-decoration: inherit;" class="mobile-logout"><li>Logout</li></a>
        </ul>
    </nav>

    <div class="hamburguer">
        <a onclick="toggleMenu()" class="btn-mobile-menu">
            <div class="icon icon-open">
                <svg style="width: 30px; height: 30px; fill: white;" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 72 72"> <path d="M56 48c2.209 0 4 1.791 4 4 0 2.209-1.791 4-4 4-1.202 0-38.798 0-40 0-2.209 0-4-1.791-4-4 0-2.209 1.791-4 4-4C17.202 48 54.798 48 56 48zM56 32c2.209 0 4 1.791 4 4 0 2.209-1.791 4-4 4-1.202 0-38.798 0-40 0-2.209 0-4-1.791-4-4 0-2.209 1.791-4 4-4C17.202 32 54.798 32 56 32zM56 16c2.209 0 4 1.791 4 4 0 2.209-1.791 4-4 4-1.202 0-38.798 0-40 0-2.209 0-4-1.791-4-4 0-2.209 1.791-4 4-4C17.202 16 54.798 16 56 16z"></path> </svg>
            </div>
            <div class="icon icon-close">
                <svg style="width: 23px;height: 23px;fill: white;margin-right: 3px;margin-top: 2px;" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 30 30"><path d="M 7 4 C 6.744125 4 6.4879687 4.0974687 6.2929688 4.2929688 L 4.2929688 6.2929688 C 3.9019687 6.6839688 3.9019687 7.3170313 4.2929688 7.7070312 L 11.585938 15 L 4.2929688 22.292969 C 3.9019687 22.683969 3.9019687 23.317031 4.2929688 23.707031 L 6.2929688 25.707031 C 6.6839688 26.098031 7.3170313 26.098031 7.7070312 25.707031 L 15 18.414062 L 22.292969 25.707031 C 22.682969 26.098031 23.317031 26.098031 23.707031 25.707031 L 25.707031 23.707031 C 26.098031 23.316031 26.098031 22.682969 25.707031 22.292969 L 18.414062 15 L 25.707031 7.7070312 C 26.098031 7.3170312 26.098031 6.6829688 25.707031 6.2929688 L 23.707031 4.2929688 C 23.316031 3.9019687 22.682969 3.9019687 22.292969 4.2929688 L 15 11.585938 L 7.7070312 4.2929688 C 7.5115312 4.0974687 7.255875 4 7 4 z"></path></svg>
            </div>
        </a>
    </div>
</header>

<main>
  <section id="detalhes"></section>

  <div>
    <h3 style="margin-bottom: 20px; margin-top: 15px;">Outros que podem te interessar: </h3>
    <!-- <div id="carouselExampleControls" class="carousel slide" data-bs-ride="carousel">
      <div class="carousel-inner" id="carousel-inner"></div>

      <button
        class="carousel-control-prev"
        type="button"
        data-bs-target="#carouselExampleControls"
        data-bs-slide="prev"
        style="background: linear-gradient(90deg, black, transparent);"
      >
        <span class="carousel-control-prev-icon" aria-hidden="true"></span>
        <span class="visually-hidden">Previous</span>
      </button>
      <button
        class="carousel-control-next"
        type="button"
        data-bs-target="#carouselExampleControls"
        data-bs-slide="next"
        style="background: linear-gradient(270deg, black, transparent);"
      >
        <span class="carousel-control-next-icon" aria-hidden="true"></span>
        <span class="visually-hidden">Next</span>
      </button>
    </div> -->
    <div class="carousel">
      <div class="group"></div>
    </div>
  </div>
</main>
<footer>
  <div class="footer-wrapper">
    <div class="footer-col">
      <h4>Sobre o Gloscars</h4>
      <p>
        O Gloscars traz os melhores filmes de cada ano, reunindo clássicos e novidades do cinema mundial para você explorar e se
        inspirar.
      </p>
    </div>
    <div class="footer-col">
      <div class="footer-infos2">
        <h4>Informações</h4>
        <p>
          <strong>Aluno:</strong> Francisco<br />
          <strong>Curso:</strong> Engenharia de Software<br />
          <strong>Turma:</strong> Noite
        </p>
      </div>
      <div class="footer-infos2">
        <h4>Redes Sociais</h4>
        <ul>
          <li><a href="https://facebook.com/">Facebook</a></li>
          <li><a href="https://instagram.com/">Instagram</a></li>
        </ul>
      </div>
    </div>
  </div>
</footer>

<link
  href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css"
  rel="stylesheet"
  integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB"
  crossorigin="anonymous"
/>
<script
  src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"
  integrity="sha384-FKyoEForCGlyvwx9Hj09JcYn3nv7wiPVlz7YYwJrWVcXK/BmnVDxM+D2scQbITxI"
  crossorigin="anonymous"
></script>
<script>
  let filmes = [];
  fetch("/filmes")
    .then((res) => res.json())
    .then((data) => {
      filmes = data;
      loadCollection(filmes);
    });

  function getQueryParam(param) {
    const urlParams = new URLSearchParams(window.location.search);
    return urlParams.get(param);
  }

  function loadCollection(filmes) {
    const ano = getQueryParam("id");
    const filme = filmes.find((f) => f.id == ano);

    if (!filme) {
      document.getElementById("detalhes").innerHTML = "<p>Filme não encontrado.</p>";
      return;
    }

    // Gêneros como labels
    const generosHtml = filme.genero.map((g) => `<span class="genero-label">${g}</span>`).join("");

    // Diretor, roteiro, elenco como listas horizontais
    const diretores = Array.isArray(filme.diretor) ? filme.diretor : [filme.diretor];
    const roteiros = Array.isArray(filme.roteiro) ? filme.roteiro : [filme.roteiro];
    const elenco = Array.isArray(filme.elenco) ? filme.elenco : [filme.elenco];

    const html = `
      <div class="detalhes-content">
          <img src="${filme.poster}" alt="${filme.titulo}" class="detalhes-poster" onerror="this.onerror=null; this.src='/assets/img/placeholder.png';"/>

        <div class="detalhes-info">

          <h1 class="detalhes-title">
            ${filme.titulo}
            <div class="favorite-icon" onclick="toggleFavorite()">
              <svg id="nofav" xmlns="http://www.w3.org/2000/svg" version="1.1" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 24 24" xml:space="preserve"><g><path d="M6.5 23.2c-.6 0-1.2-.2-1.7-.5-.8-.7-1.2-1.7-1-2.8l.8-4.6L1.2 12c-.8-.7-1-1.8-.7-2.9.3-1 1.2-1.8 2.3-1.9l4.7-.7 2.1-4.2c.5-.9 1.5-1.6 2.5-1.6 1.1 0 2 .6 2.5 1.6l2.1 4.2 4.6.7c1.1.2 1.9.9 2.3 1.9.3 1 .1 2.1-.7 2.9l-3.3 3.3.8 4.6c.2 1.1-.2 2.1-1.1 2.7s-2 .7-2.9.2L12 20.7l-4.2 2.2c-.3.2-.8.3-1.3.3zM12 1.8c-.7 0-1.3.4-1.6 1L8.2 7.2c-.1.2-.2.3-.4.3l-4.9.7c-.7.1-1.2.6-1.4 1.3s0 1.4.5 1.8l3.5 3.5c.1.1.2.3.1.4l-.8 4.9c-.1.7.2 1.4.7 1.8.5.3 1.3.4 1.9.1l4.4-2.3c.1-.1.3-.1.5 0l4.4 2.3c.6.3 1.4.3 1.9-.1.6-.4.8-1.1.7-1.8l-.8-4.9c0-.2 0-.3.1-.4l3.5-3.5c.5-.5.7-1.2.5-1.8-.2-.7-.8-1.1-1.5-1.2l-4.9-.7c-.2 0-.3-.1-.4-.3l-2.2-4.4c-.3-.7-.9-1.1-1.6-1.1z"></path></g></svg>
              <svg id="trfav" xmlns="http://www.w3.org/2000/svg" version="1.1" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 24 24" xml:space="preserve"><g><path d="M17.5 23.3c-.5 0-.9-.1-1.3-.3L12 20.8 7.8 23c-.9.5-2.1.4-3-.2-.8-.7-1.3-1.7-1.1-2.8l.8-4.7L1.1 12C.3 11.3 0 10.2.4 9.1c.3-1 1.2-1.8 2.3-1.9l4.7-.7 2.1-4.3C10 1.2 11 .6 12 .6s2 .6 2.5 1.6l2.1 4.3 4.7.7c1.1.2 1.9.9 2.3 1.9.3 1 .1 2.1-.7 2.9l-3.4 3.3.8 4.7c.2 1.1-.2 2.1-1.1 2.8-.5.3-1.1.5-1.7.5z"></path></g></svg>
            </div>
          </h1>

          <div class="generos">${generosHtml}</div>

          <div class="detalhes-blocos">

            <a href="${filme.trailer}" target="_blank" class="btn-trailer" rel="noopener noreferrer">
              <svg xmlns="http://www.w3.org/2000/svg" version="1.1" xmlns:xlink="http://www.w3.org/1999/xlink" width="512" height="512" x="0" y="0" viewBox="0 0 163.861 163.861" style="enable-background:new 0 0 512 512" xml:space="preserve">
              <g><path d="M34.857 3.613C20.084-4.861 8.107 2.081 8.107 19.106v125.637c0 17.042 11.977 23.975 26.75 15.509L144.67 97.275c14.778-8.477 14.778-22.211 0-30.686L34.857 3.613z" fill="#fff" opacity="1"></path></g>
              </svg>
            </a>

            <div class="bloco-vertical">
              <span class="bloco-label">NOTA IMDB</span>
              <span class="bloco-valor">${filme.imdb}</span>
            </div>

            <div class="bloco-vertical">
              <span class="bloco-label">LANÇAMENTO</span>
              <span class="bloco-valor">${filme.lancamento}</span>
            </div>

            <div class="bloco-vertical">
              <span class="bloco-label">DURAÇÃO</span>
              <span class="bloco-valor">${filme.duracao} min</span>
            </div>

          </div>

          <div class="sinopse-section">
            <h2 class="sinopse-header">SINOPSE</h2>
            <p class="sinopse-text">${filme.sinopse}</p>
          </div>

          <div class="listas-info">
            <div class="lista-info">
              <strong>Diretor:</strong>
              <ul>${diretores.map((d) => `<li>${d}</li>`).join("")}</ul>
            </div>

            <div class="lista-info">
              <strong>Roteiro:</strong>
              <ul>${roteiros.map((r) => `<li>${r}</li>`).join("")}</ul>
            </div>

            <div class="lista-info">
              <strong>Elenco:</strong>
              <ul>${elenco.map((e) => `<li>${e}</li>`).join("")}</ul>
            </div>
          </div>

        </div>
      </div>
    `;

    document.getElementById("detalhes").innerHTML = html;

    if(filme.favorite == 1) {
      document.getElementById("nofav").style.display = "none";
      document.getElementById("trfav").style.display = "block";
    } else if (filme.favorite == 0 || !filme.favorite) {
      document.getElementById("nofav").style.display = "block";
      document.getElementById("trfav").style.display = "none";
    };

    loadCol2(filme.ano);
  }


function loadCol2(idAtual) {
  let html = "";
  let carousel = document.querySelector(".group");
  if (!carousel) return;

  let lista = filmes.filter(f => f.id != idAtual);

  for (let f of lista) {
    html += `
      <div class="c">
        <a href="/detalhes.html?id=${f.id}">
          <img src="${f.poster}"
               alt="${f.titulo}"
               onerror="this.onerror=null; this.src='/assets/img/placeholder.png';"
               class="poster rounded-3">
        </a>
      </div>`;
  }

  carousel.innerHTML = html + html;
}

// Também chama na inicialização para garantir o carregamento correto
window.addEventListener('load', () => {
  const idAtual = getQueryParam('id');
  // if (ano) loadCol(ano);
  if (idAtual) loadCol2(idAtual);
});

  function toggleFavorite() {
    const ano = getQueryParam("id"); // pega o id do filme da URL
    const filme = filmes.find(f => f.id == ano);
    if (!filme) return;

    // Alterna o valor do favorite
    const novoValor = filme.favorite === 1 ? 0 : 1;

    fetch(`/filmes/${filme.id}`, {
      method: "PATCH", // só altera o campo necessário
      headers: {
        "Content-Type": "application/json"
      },
      body: JSON.stringify({ favorite: novoValor })
    })
    .then(res => {
      if (!res.ok) throw new Error("Erro ao atualizar favorito");
      return res.json();
    })
    .then(updatedFilme => {
      // Atualiza o array local para refletir a mudança
      filme.favorite = updatedFilme.favorite;

      // Atualiza o ícone visualmente
      const icon = document.querySelector(".favorite-icon svg");
      if (filme.favorite === 1) {
        document.getElementById("nofav").style.display = "none";
        document.getElementById("trfav").style.display = "block";
      } else {
        document.getElementById("nofav").style.display = "block";
        document.getElementById("trfav").style.display = "none";
      }
    })
    .catch(err => console.error(err));
  }
</script>
<script src="/assets/js/app.js"></script>
</body>
</html>
