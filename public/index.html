<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gloscars - Os Melhores Filmes de Cada Ano</title>
    <link rel="stylesheet" href="/assets/css/styles.css">
    <script>
    (()=>{
    const logado = sessionStorage.getItem('isLoggedIn');
        if (logado !== '1' || !logado) {
            window.location.href = 'login.html';
            return;
        }
    })();
    document.addEventListener('DOMContentLoaded', () => {
        const admin = JSON.parse(sessionStorage.getItem('usuarioCorrente') || '{}');

        if (admin.admin === 0) {
            // Se estiver na página de registro, bloqueia
            if (window.location.pathname.endsWith('register.html')) {
                alert('Acesso negado. Você não é um admin.');
                window.location.href = 'index.html';
            }

            // Esconde o link de registro no menu
            const regLink = document.querySelector('a[href="register.html"]');
            if (regLink) regLink.style.display = 'none';
        }
    });
    </script>
</head>
<style>
    header {
        position: absolute;
    }
    header::before {
    content: "";
    position: absolute;
    top: -16px;
    left: 50%;
    transform: translateX(-50%);
    width: 100vw;
    height: 180px;
    pointer-events: none;
    z-index: -1;
    background: linear-gradient(
        to bottom,
        rgba(0,0,0,0.55) 0%,
        rgba(0,0,0,0.25) 50%,
        rgba(0,0,0,0) 100%
    );
}
    .favorite-icon {
        border-radius: 50px;
        cursor: pointer;
        user-select: none;
        text-shadow: 0 0 4px rgba(0, 0, 0, 0.7);
        align-items: center;
        display: flex;
        justify-content: center;
        position: absolute;
        top: 5px;
        right: 10px;
        width: 20px;
        height: 20px;
        z-index: 2;
    }
    /* .favorite-icon::before {
        content: "";
        position: absolute;
        top: 70%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 30px;
        height: 30px;
        background: rgba(0, 0, 0, 0.5);
        border-radius: 50%;
        z-index: -1;
        pointer-events: none;
    } */
    .favorite-icon::before {
        content: "";
        position: absolute;
        top: -20px;
        right: -20px;
        width: 200px;
        height: 200px;
        background: linear-gradient(225deg, #000000b0 5%, transparent 40%);
        z-index: -1;
        pointer-events: none;
    }
    .favorite-icon svg {
        transition: transform 0.2s;
        fill: white;
        margin-top: 7px;
    }
    .trfav {
        fill: #b39930 !important ;
    }
    .favorite-icon svg:hover {
        transform: scale(1.05);
    }
    #searchInput {
        padding: 2px 12px;
        border-radius: 4px;
        border: none;
        width: 100%;
        max-width: 260px;
        background: #111;
        color: #fff;
        outline: none;
    }
    #searchInput::placeholder {
        color: #777;
    }
    #dateofmovies {
        background: #333;
        padding: 2px 10px;
        border-radius: 50px;
    }
    .titles-wrapper {
        display: flex;
        gap: 15px;
        align-items: center;
    }
    .titles-wrapper span {
        white-space: nowrap;
    }
    @media (max-width: 600px) {
        .titles-wrapper {
            align-items: flex-start;
            flex-direction: column-reverse;
            gap: 10px;
        }
        .title-box {
            flex-direction: column;
            gap: 10px;
            padding-bottom: 10px;
        }
        .search-box {
            width: 100%;
        }
        #searchInput {
            max-width: none;
        }
    }
</style>
<body class="bg-black text-white">
    <!-- HEADER -->
    <header>
        <a href="index.html"><div class="logo">
            <img src="/assets/img/logo.svg" style="max-width: 180px; filter: brightness(50)">
        </div></a>
        <nav>
            <ul id="menuList">
                <a href="index.html" style="color: inherit; text-decoration: inherit;"><li>Início</li></a>
                <a href="register.html" style="color: inherit; text-decoration: inherit;"><li>Cadastro</li></a>
                <a href="favorites.html" style="color: inherit; text-decoration: inherit;"><li>Favorito</li></a>
                <a href="login.html" style="color: inherit; text-decoration: inherit;" class="mobile-logout"><li>Logout</li></a>
            </ul>
        </nav>

        <div class="hamburguer">
            <a onclick="toggleMenu()" class="btn-mobile-menu">
                <div class="icon icon-open">
                    <svg style="width: 30px; height: 30px; fill: white;" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 72 72"> <path d="M56 48c2.209 0 4 1.791 4 4 0 2.209-1.791 4-4 4-1.202 0-38.798 0-40 0-2.209 0-4-1.791-4-4 0-2.209 1.791-4 4-4C17.202 48 54.798 48 56 48zM56 32c2.209 0 4 1.791 4 4 0 2.209-1.791 4-4 4-1.202 0-38.798 0-40 0-2.209 0-4-1.791-4-4 0-2.209 1.791-4 4-4C17.202 32 54.798 32 56 32zM56 16c2.209 0 4 1.791 4 4 0 2.209-1.791 4-4 4-1.202 0-38.798 0-40 0-2.209 0-4-1.791-4-4 0-2.209 1.791-4 4-4C17.202 16 54.798 16 56 16z"></path> </svg>
                </div>
                <div class="icon icon-close">
                    <svg style="width: 23px;height: 23px;fill: white;margin-right: 3px;margin-top: 2px;" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 30 30"><path d="M 7 4 C 6.744125 4 6.4879687 4.0974687 6.2929688 4.2929688 L 4.2929688 6.2929688 C 3.9019687 6.6839688 3.9019687 7.3170313 4.2929688 7.7070312 L 11.585938 15 L 4.2929688 22.292969 C 3.9019687 22.683969 3.9019687 23.317031 4.2929688 23.707031 L 6.2929688 25.707031 C 6.6839688 26.098031 7.3170313 26.098031 7.7070312 25.707031 L 15 18.414062 L 22.292969 25.707031 C 22.682969 26.098031 23.317031 26.098031 23.707031 25.707031 L 25.707031 23.707031 C 26.098031 23.316031 26.098031 22.682969 25.707031 22.292969 L 18.414062 15 L 25.707031 7.7070312 C 26.098031 7.3170312 26.098031 6.6829688 25.707031 6.2929688 L 23.707031 4.2929688 C 23.316031 3.9019687 22.682969 3.9019687 22.292969 4.2929688 L 15 11.585938 L 7.7070312 4.2929688 C 7.5115312 4.0974687 7.255875 4 7 4 z"></path></svg>
                </div>
            </a>
        </div>
    </header>
    <div id="menuOverlay" class="menu-overlay"></div>
    
    <!-- DIV CARROSSEL -->
    <div id="carouselExampleSlidesOnly" class="carousel slide carousel-fade" data-bs-ride="carousel" data-bs-interval="3000">
        <!-- CARROSSEL DENTRO -->
        <div class="carousel-inner rounded-3">
            <div class="carousel-item active">
            <a href="/detalhes.html?id=5fec">
                <picture>
                    <source media="(max-width: 768px)" srcset="/assets/img/2024-mobile.webp">
                    <img src="/assets/img/2024-main.webp" class="d-block w-100">
                </picture>
            </a>
            </div>
            <div class="carousel-item">
            <a href="/detalhes.html?id=d3a5">
                <picture>
                    <source media="(max-width: 768px)" srcset="/assets/img/2023-mobile.webp">
                    <img src="/assets/img/2023-main.webp" class="d-block w-100">
                </picture>
            </a>
            </div>
            <div class="carousel-item">
            <a href="/detalhes.html?id=c4f8">
                <picture>
                    <source media="(max-width: 768px)" srcset="/assets/img/2022-mobile.webp">
                    <img src="/assets/img/2022-main.webp" class="d-block w-100">
                </picture>
            </a>
            </div>
        </div>
    </div>

    <!-- MAIN -->
    <main>
        <!-- LISTA DOS FILMES -->
        <section class="content">
            <div class="catalog">
                <!-- TITULO -->
                <div class="title-box">
                    <div class="titles-wrapper">
                        <h3>Os Melhores Filmes de Cada Ano</h3>
                        <span id="dateofmovies"></span>
                    </div>
                    <div class="search-box form-floating">
                        <input class="form-control" type="text" id="searchInput" placeholder="Pesquisar...">
                    </div>
                </div>

                <!-- FILMES -->
                <div class="collection-box">
                    <div class="collection-line" id="colLine">
                    </div>
                </div>
            </div>
        </section>
        <section class="content">
            <div class="title-box">
                <h3>Distribuição de Gêneros dos Filmes</h3>
            </div>
            <div class="chart-wrapper">
            <canvas id="genreChart"></canvas>
            </div>
        </section>
    </main>

    <footer>
    <div class="footer-wrapper">
        <div class="footer-col">
            <h4>Sobre o Gloscars</h4>
            <p>O Gloscars traz os melhores filmes de cada ano, reunindo clássicos e novidades do cinema mundial para você explorar e se inspirar.</p>
        </div>
        <div class="footer-col">
            <div class="footer-infos2">
                <h4>Informações</h4>
                <p>
                    <strong>Aluno:</strong> Francisco<br>
                    <strong>Curso:</strong> Engenharia de Software<br>
                    <strong>Turma:</strong> Noite
                </p>
            </div>
            <div class="footer-infos2">
                <h4>Redes Sociais</h4>
                <ul>
                    <li><a href="https://facebook.com/">Facebook</a></li>
                    <li><a href="https://instagram.com/">Instagram</a></li>
                </ul>
            </div>
        </div>
    </div>
    </footer>
<!-- SCRIPTS ABAIXO -->    
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB" crossorigin="anonymous">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js" integrity="sha384-FKyoEForCGlyvwx9Hj09JcYn3nv7wiPVlz7YYwJrWVcXK/BmnVDxM+D2scQbITxI" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    let filmes = [];
    function loadCollection(filmes) {
        colItem = '';
        let colLine = document.getElementById('colLine');
        antigo=filmes[0].ano,novo=filmes[0].ano;
        for(let i = 0; i < filmes.length; i++) {
            filme = filmes[i];
            if(filme.ano < antigo) {antigo = filme.ano;}
            if(filme.ano > novo) {novo = filme.ano; }
            colItem += `<div class="collection-item">
                            <a href="/detalhes.html?id=${filme.id}">
                                <img src="${filme.poster}" class="poster" 
                                style="max-width: 100%; border-radius: var(--radius);"
                                onerror="this.onerror=null; this.src='/assets/img/placeholder.png';">
                                </img>
                            </a>
                            <div class="favorite-icon" onclick="toggleFavorite(this, event)" data-id="${filme.id}">
                                <svg class="nofav" xmlns="http://www.w3.org/2000/svg" version="1.1" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 24 24" xml:space="preserve"><g><path d="M6.5 23.2c-.6 0-1.2-.2-1.7-.5-.8-.7-1.2-1.7-1-2.8l.8-4.6L1.2 12c-.8-.7-1-1.8-.7-2.9.3-1 1.2-1.8 2.3-1.9l4.7-.7 2.1-4.2c.5-.9 1.5-1.6 2.5-1.6 1.1 0 2 .6 2.5 1.6l2.1 4.2 4.6.7c1.1.2 1.9.9 2.3 1.9.3 1 .1 2.1-.7 2.9l-3.3 3.3.8 4.6c.2 1.1-.2 2.1-1.1 2.7s-2 .7-2.9.2L12 20.7l-4.2 2.2c-.3.2-.8.3-1.3.3zM12 1.8c-.7 0-1.3.4-1.6 1L8.2 7.2c-.1.2-.2.3-.4.3l-4.9.7c-.7.1-1.2.6-1.4 1.3s0 1.4.5 1.8l3.5 3.5c.1.1.2.3.1.4l-.8 4.9c-.1.7.2 1.4.7 1.8.5.3 1.3.4 1.9.1l4.4-2.3c.1-.1.3-.1.5 0l4.4 2.3c.6.3 1.4.3 1.9-.1.6-.4.8-1.1.7-1.8l-.8-4.9c0-.2 0-.3.1-.4l3.5-3.5c.5-.5.7-1.2.5-1.8-.2-.7-.8-1.1-1.5-1.2l-4.9-.7c-.2 0-.3-.1-.4-.3l-2.2-4.4c-.3-.7-.9-1.1-1.6-1.1z"></path></g></svg>
                                <svg class="trfav" xmlns="http://www.w3.org/2000/svg" version="1.1" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 24 24" xml:space="preserve"><g><path d="M17.5 23.3c-.5 0-.9-.1-1.3-.3L12 20.8 7.8 23c-.9.5-2.1.4-3-.2-.8-.7-1.3-1.7-1.1-2.8l.8-4.7L1.1 12C.3 11.3 0 10.2.4 9.1c.3-1 1.2-1.8 2.3-1.9l4.7-.7 2.1-4.3C10 1.2 11 .6 12 .6s2 .6 2.5 1.6l2.1 4.3 4.7.7c1.1.2 1.9.9 2.3 1.9.3 1 .1 2.1-.7 2.9l-3.4 3.3.8 4.7c.2 1.1-.2 2.1-1.1 2.8-.5.3-1.1.5-1.7.5z"></path></g></svg>
                            </div>
                        </div>`;
        }
        colLine.innerHTML = colItem;
        filmes.forEach(function(filme) {
            let favoriteIcon = document.querySelector(`.favorite-icon[data-id="${filme.id}"]`);
            if (!favoriteIcon) return; // evita erro se não encontrar

            let nofav = favoriteIcon.querySelector(".nofav");
            let trfav = favoriteIcon.querySelector(".trfav");

            if(filme.favorite == 1) {
                nofav.style.display = "none";
                trfav.style.display = "block";
            } else {
                nofav.style.display = "block";
                trfav.style.display = "none";
            }
        });
        antigo != novo ? document.getElementById("dateofmovies").innerHTML = `${antigo} - ${novo}` : document.getElementById("dateofmovies").innerHTML = `${antigo}`;
    }
    // Função do gráfico
    function renderGenreChart(filmes) {
    const genreCounts = {};

    filmes.forEach(filme => {
    (filme.genero || []).forEach(genero => {
        genreCounts[genero] = (genreCounts[genero] || 0) + 1;
    }); });

    const labels = Object.keys(genreCounts);
    const values = Object.values(genreCounts);

    if (!labels.length) {
    console.warn('Nenhum gênero encontrado nos filmes.');
    return;
    }

    const ctx = document.getElementById('genreChart').getContext('2d');

    new Chart(ctx, {
    type: 'pie',
    data: {
        labels: labels,
        datasets: [{
        data: values,
        backgroundColor: [
            '#e74c3c','#3498db','#f1c40f','#2ecc71','#9b59b6','#e67e22','#1abc9c','#95a5a6','#ff6b81','#fd79a8','#55efc4','#ffeaa7'
        ], borderWidth: 1
        }]
    },
    options: {
        plugins: {
        legend: {
            position: 'bottom',
            labels: {
            color: '#ffffff'
            }
        }
        }
    }
    });
}
function loadCharts(filmes) {
    renderGenreChart(filmes);
}
    fetch('/filmes')
    .then(res => {
        if (!res.ok) {
        throw new Error(`Erro na resposta: ${res.status} ${res.statusText}`);
        }
        return res.json();
    })
    .then(data => {
        loadCollection(data);
        loadCharts(data);
        filmes = data;

        const searchInput = document.getElementById('searchInput');
        if (searchInput) {
            searchInput.addEventListener('input', (e) => {
                filtrarFilmes(e.target.value);
            });
        }
    })
    .catch(err => {
        console.error("Erro ao carregar /filmes:", err);
        // opcional: feedback na UI
        document.querySelector('#erro').textContent = 
        "Não foi possível carregar os dados. Tente recarregar.";
    });
function filtrarFilmes(termo) {
    termo = (termo || '').trim().toLowerCase();

    // se não digitou nada, mostra tudo
    if (!termo) {
        loadCollection(filmes);
        loadCharts(filmes);
        return;
    }

    const filtrados = filmes.filter(filme => {
        const titulo  = (filme.titulo || '').toLowerCase();
        const ano     = String(filme.ano || '');
        const generos = (filme.genero || []).join(' ').toLowerCase();

        return (
            titulo.includes(termo) ||
            ano.includes(termo)    ||
            generos.includes(termo)
        );
    });

    loadCollection(filtrados);
    loadCharts(filtrados);
}

function toggleFavorite(favoriteIconDiv, event) {
  event.stopPropagation(); // bloqueia clique no <a>
  const id = favoriteIconDiv.dataset.id;
  const filme = filmes.find(f => f.id == id);
  if (!filme) return;

  const novoValor = filme.favorite === 1 ? 0 : 1;

  const nofav = favoriteIconDiv.querySelector(".nofav");
  const trfav = favoriteIconDiv.querySelector(".trfav");

  fetch(`/filmes/${filme.id}`, {
    method: "PATCH",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ favorite: novoValor })
  })
  .then(res => res.json())
  .then(updatedFilme => {
    filme.favorite = updatedFilme.favorite;
    if (filme.favorite === 1) {
      nofav.style.display = "none";
      trfav.style.display = "block";
    } else {
      nofav.style.display = "block";
      trfav.style.display = "none";
    }
  })
  .catch(err => console.error(err));
}
</script>
<script src="/assets/js/app.js"></script>
</body>
</html>